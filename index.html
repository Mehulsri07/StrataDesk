<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StrataDesk - Groundwater Data Management</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#0b5fff">
  <meta name="background-color" content="#0f172a">
  <meta name="display" content="standalone">
  <meta name="orientation" content="any">
  
  <!-- iOS PWA Support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="StrataDesk">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  
  <!-- Windows PWA Support -->
  <meta name="msapplication-TileColor" content="#0b5fff">
  <meta name="msapplication-TileImage" content="icons/icon-144.png">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16.png">
  
  <!-- External Dependencies -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  
  <!-- Local Stylesheets -->
  <link rel="stylesheet" href="styles/variables.css">
  <link rel="stylesheet" href="styles/base.css">
  <link rel="stylesheet" href="styles/components.css">
  <link rel="stylesheet" href="styles/layout.css">
  <link rel="stylesheet" href="styles/responsive.css">
</head>
<body class="app-body">
  <!-- Custom Electron Title Bar -->
  <div class="electron-titlebar">
    <div class="titlebar-drag-region">
      <div class="titlebar-left">
        <img src="icons/icon.png" alt="StrataDesk" class="titlebar-icon">
        <span class="titlebar-title">StrataDesk</span>
        <span id="titlebarProject" class="titlebar-project"></span>
      </div>
      <div class="titlebar-center"></div>
      <div class="titlebar-right">
        <button id="titlebarMinimize" class="titlebar-btn titlebar-minimize" title="Minimize">
          <svg width="12" height="12" viewBox="0 0 12 12">
            <rect x="2" y="5" width="8" height="2" fill="currentColor"/>
          </svg>
        </button>
        <button id="titlebarMaximize" class="titlebar-btn titlebar-maximize" title="Maximize">
          <svg width="12" height="12" viewBox="0 0 12 12">
            <rect x="2" y="2" width="8" height="8" stroke="currentColor" stroke-width="1.5" fill="none"/>
          </svg>
        </button>
        <button id="titlebarClose" class="titlebar-btn titlebar-close" title="Close">
          <svg width="12" height="12" viewBox="0 0 12 12">
            <path d="M2 2 L10 10 M10 2 L2 10" stroke="currentColor" stroke-width="1.5"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Main App Container -->
  <div class="app-container">
    <!-- Login Screen -->
    <div id="loginPanel" class="login-screen">
      <div class="login-container">
        <div class="login-header">
          <img src="icons/icon.png" alt="StrataDesk" class="login-logo">
          <h1 class="login-title">StrataDesk</h1>
          <p class="login-subtitle">Professional Groundwater Data Management</p>
        </div>
        
        <div class="login-form">
          <div class="form-group">
            <input id="username" placeholder="Username" class="login-input">
          </div>
          <div class="form-group">
            <input id="password" placeholder="Password" type="password" class="login-input">
          </div>
          
          <div class="login-actions">
            <button id="loginBtn" class="btn-primary login-btn" onclick="console.log('Login clicked inline'); if(window.uiManager) window.uiManager.handleLogin();">Sign In</button>
            <button id="registerBtn" class="btn-secondary register-btn" onclick="console.log('Register clicked inline'); if(window.uiManager) window.uiManager.handleRegister();">Create Account</button>
          </div>
          
          <div class="login-divider">
            <span>or</span>
          </div>
          
          <button id="guestBtn" class="btn-guest" onclick="console.log('Guest clicked inline'); if(window.uiManager) window.uiManager.handleGuestLogin();">Continue as Guest</button>
          
          <div id="loginMsg" class="login-message"></div>
        </div>
        
        <div class="login-footer">
          <p>Your data stays secure in your browser</p>
        </div>
      </div>
    </div>

    <!-- Main Application -->
    <div id="appPanel" class="main-app hidden">
      <!-- Simplified Top Navigation Bar -->
      <div class="app-navbar">
        <div class="navbar-left">
          <div class="user-profile">
            <div class="user-avatar">üë§</div>
            <div class="user-info">
              <span id="welcomeUser" class="user-name">Welcome</span>
              <span id="userInfo" class="user-status">Local account</span>
            </div>
          </div>
        </div>
        
        <div class="navbar-right">
          <button id="exportAll" class="btn-secondary export-btn" onclick="console.log('Export all clicked'); if(window.uiManager) window.uiManager.handleExportAll();">üì¶ Backup All</button>
          <button id="logoutBtn" class="btn-logout" onclick="console.log('Logout clicked'); if(window.uiManager) window.uiManager.handleLogout();">Sign Out</button>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="app-content">
        <!-- Simplified Main View: Map + Bottom Panel -->
        <div class="main-view">
          <!-- Map Container (Full Screen) -->
          <div class="map-view">
            <div class="map-header">
              <h2>StrataDesk</h2>
              <div class="map-actions">
                <button id="addBoringBtn" class="btn-primary add-boring-btn">
                  <span>‚ûï</span>
                  <span>Add Boring</span>
                </button>
                <button id="viewAllBtn" class="btn-secondary view-all-btn">
                  <span>üìã</span>
                  <span>View All</span>
                </button>
                <button id="settingsBtn" class="btn-icon" title="Settings">
                  <span>‚öôÔ∏è</span>
                </button>
                <button id="darkModeToggle" class="btn-icon theme-toggle" title="Toggle Dark Mode">
                  <span class="theme-icon">üåô</span>
                </button>
              </div>
            </div>
            <div id="map" class="map-container"></div>
          </div>

          <!-- Bottom Panel: Recent Borings -->
          <div class="bottom-panel">
            <div class="panel-header">
              <h3>Recent Borings</h3>
              <div class="panel-actions">
                <button id="searchToggle" class="btn-icon" title="Search">üîç</button>
                <button id="refreshBtn" class="btn-icon" title="Refresh">üîÑ</button>
              </div>
            </div>
            
            <!-- Search Bar (Hidden by default) -->
            <div id="searchBar" class="search-bar hidden">
              <input id="searchInput" type="text" placeholder="Search bore IDs, locations, tags..." class="search-input">
              <button id="clearSearchBtn" class="btn-clear">‚úï</button>
            </div>
            
            <!-- Recent Borings List -->
            <div id="recentBorings" class="recent-borings">
              <div class="boring-item">
                <div class="boring-info">
                  <div class="boring-id">TW-21</div>
                  <div class="boring-location">25.12, 82.54</div>
                  <div class="boring-date">Jan 18, 2026</div>
                </div>
                <div class="boring-layers">5 layers</div>
                <div class="boring-actions">
                  <button class="btn-icon" title="View on map">üìç</button>
                  <button class="btn-icon" title="Edit">‚úèÔ∏è</button>
                </div>
              </div>
              
              <div class="boring-item">
                <div class="boring-info">
                  <div class="boring-id">TW-22</div>
                  <div class="boring-location">25.15, 82.60</div>
                  <div class="boring-date">Jan 17, 2026</div>
                </div>
                <div class="boring-layers">3 layers</div>
                <div class="boring-actions">
                  <button class="btn-icon" title="View on map">üìç</button>
                  <button class="btn-icon" title="Edit">‚úèÔ∏è</button>
                </div>
              </div>
              
              <div class="boring-item">
                <div class="boring-info">
                  <div class="boring-id">TW-23</div>
                  <div class="boring-location">25.10, 82.50</div>
                  <div class="boring-date">Jan 16, 2026</div>
                </div>
                <div class="boring-layers">4 layers</div>
                <div class="boring-actions">
                  <button class="btn-icon" title="View on map">üìç</button>
                  <button class="btn-icon" title="Edit">‚úèÔ∏è</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Boring Modal -->
      <div id="addBoringModal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <div class="modal-header">
            <h2>Add New Boring</h2>
            <button class="modal-close" onclick="closeAddBoringModal()">‚úï</button>
          </div>
          <div class="modal-body">
            <div class="add-boring-options">
              <div class="option-card" onclick="selectAddOption('upload')">
                <div class="option-icon">üìÑ</div>
                <div class="option-title">Upload Strata Chart</div>
                <div class="option-description">PDF or Excel with layers<br>‚Üí Auto-extract layers</div>
              </div>
              
              <div class="option-card" onclick="selectAddOption('manual')">
                <div class="option-icon">‚úçÔ∏è</div>
                <div class="option-title">Manual Entry</div>
                <div class="option-description">Enter layer data by hand</div>
              </div>
              
              <div class="option-card" onclick="selectAddOption('files')">
                <div class="option-icon">üìÅ</div>
                <div class="option-title">Attach Files Only</div>
                <div class="option-description">No layer extraction</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- View All Modal -->
      <div id="viewAllModal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content large">
          <div class="modal-header">
            <h2>All Borings</h2>
            <button class="modal-close" onclick="closeViewAllModal()">‚úï</button>
          </div>
          <div class="modal-body">
            <div class="view-all-content">
              <div class="view-all-filters">
                <input type="text" placeholder="Search..." class="filter-input">
                <select class="filter-select">
                  <option>All Projects</option>
                  <option>Project 1</option>
                  <option>Project 2</option>
                </select>
                <select class="filter-select">
                  <option>All Dates</option>
                  <option>Last 7 days</option>
                  <option>Last 30 days</option>
                </select>
              </div>
              
              <div class="view-all-table">
                <table class="borings-table">
                  <thead>
                    <tr>
                      <th>Bore ID</th>
                      <th>Location</th>
                      <th>Date</th>
                      <th>Layers</th>
                      <th>Project</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="allBoringsTable">
                    <!-- Will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- External Libraries with Multiple Fallbacks -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
  <script>
    // Fallback for bcryptjs if primary CDN fails
    if (typeof bcryptjs === 'undefined' && typeof dcodeIO !== 'undefined' && dcodeIO.bcrypt) {
      window.bcryptjs = dcodeIO.bcrypt;
    }
    if (typeof bcryptjs === 'undefined') {
      document.write('<script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"><\/script>');
    }
  </script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    // Fallback for JSZip if primary CDN fails
    if (typeof JSZip === 'undefined') {
      document.write('<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"><\/script>');
    }
  </script>
  
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Fallback for Leaflet if primary CDN fails
    if (typeof L === 'undefined') {
      document.write('<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"><\/script>');
    }
  </script>

  <!-- Application Scripts -->
  <script src="js/init-check.js"></script>
  <script src="js/core/config.js"></script>
  <script src="js/core/database.js"></script>
  <script src="js/core/auth.js"></script>
  <script src="js/core/api.js"></script>
  <script src="js/modules/projects.js"></script>
  <script src="js/modules/map.js"></script>
  <script src="js/modules/files.js"></script>
  <script src="js/modules/search.js"></script>
  <script src="js/modules/data-panel.js"></script>
  <script src="js/modules/tab-manager.js"></script>
  <script src="js/modules/quick-extraction.js"></script>
  <script src="js/modules/simplified-ui.js"></script>
  <script src="js/modules/ui.js"></script>
  <script src="js/app.js"></script>
  <script src="js/enhanced-features.js"></script>
  <script src="js/tips-system.js"></script>
  
  <!-- Strata Chart Extraction Module -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Configure PDF.js worker
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
  <script src="js/extraction/Unit.js"></script>
  <script src="js/extraction/StrataChart.js"></script>
  <script src="js/extraction/ErrorClassifier.js"></script>
  <script src="js/extraction/DepthNormalizer.js"></script>
  <script src="js/extraction/FallbackManager.js"></script>
  <script src="js/extraction/ErrorHandler.js"></script>
  <script src="js/extraction/ValidationService.js"></script>
  <script src="js/extraction/ExcelProcessor.js"></script>
  <script src="js/extraction/PDFProcessor.js"></script>
  <script src="js/extraction/ReviewInterface.js"></script>
  <script src="js/extraction/StrataExtractor.js"></script>
  <script src="js/extraction/ExtractionUI.js"></script>
  <script src="js/extraction/index.js"></script>
  <script src="js/modules/extraction-tab.js"></script>
  
  <!-- Enhanced Address Search (Optional) -->
  <script>
    // Load enhanced address search components if available
    (function() {
      const scripts = [
        'js/features/utils/Logger.js',
        'js/features/utils/LocationPersistence.js',
        'js/features/controllers/AddressSearchController.js',
        'js/features/controllers/DropdownController.js',
        'js/features/controllers/KeyboardNavigationController.js',
        'js/features/AddressSearchIntegration.js'
      ];
      
      let loadedCount = 0;
      const totalScripts = scripts.length;
      
      function loadScript(src) {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = src;
          script.onload = () => {
            loadedCount++;
            console.log(`Loaded: ${src} (${loadedCount}/${totalScripts})`);
            resolve();
          };
          script.onerror = () => {
            console.warn(`Failed to load: ${src}`);
            resolve(); // Don't reject, just continue
          };
          document.head.appendChild(script);
        });
      }
      
      // Load scripts sequentially
      async function loadEnhancedFeatures() {
        for (const script of scripts) {
          await loadScript(script);
        }
        
        if (loadedCount === totalScripts) {
          console.log('‚úÖ Enhanced address search features loaded');
          window.enhancedFeaturesAvailable = true;
        } else {
          console.log('‚ö†Ô∏è Some enhanced features failed to load, using basic functionality');
          window.enhancedFeaturesAvailable = false;
        }
      }
      
      loadEnhancedFeatures();
    })();
  </script>

  <!-- PWA Service Worker Registration -->
  <script>
    // Register service worker for PWA functionality
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('./sw.js');
          console.log('StrataDesk PWA: Service Worker registered successfully');
          
          // Handle updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // New version available
                if (confirm('A new version of StrataDesk is available. Update now?')) {
                  window.location.reload();
                }
              }
            });
          });
        } catch (error) {
          console.log('StrataDesk PWA: Service Worker registration failed:', error);
        }
      });
    }

    // PWA Install prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Show install button/banner
      const installBanner = document.createElement('div');
      installBanner.innerHTML = `
        <div style="position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; font-size: 14px; max-width: 300px;">
          <div style="margin-bottom: 8px;">üì± Install StrataDesk as an app for better experience!</div>
          <div style="display: flex; gap: 8px;">
            <button onclick="installPWA()" style="background: white; color: var(--primary); border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Install</button>
            <button onclick="this.parentElement.parentElement.remove()" style="background: transparent; color: white; border: 1px solid white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Later</button>
          </div>
        </div>
      `;
      document.body.appendChild(installBanner);
    });

    // Install PWA function
    window.installPWA = async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log('StrataDesk PWA: Install prompt result:', outcome);
        deferredPrompt = null;
        
        // Remove install banner
        const banner = document.querySelector('[style*="position: fixed"]');
        if (banner) banner.remove();
      }
    };

    // Track PWA usage
    window.addEventListener('appinstalled', () => {
      console.log('StrataDesk PWA: App installed successfully');
      UTILS.showToast('StrataDesk installed successfully! üéâ', 'success');
    });
  </script>

  <script>
    // Global functions for strata layer management
    function addStrataLayer() {
      if (window.uiManager && window.uiManager.addStrataLayer) {
        window.uiManager.addStrataLayer();
      } else {
        console.error('uiManager not available or addStrataLayer method missing');
      }
    }
  </script>
</body>
</html>